<!-- AI解析表单 - 改进版 -->
<form id="parse-form" method="post"
      hx-post="{% if content_type == 'job' %}{% url 'jobs:parse_jobs' %}{% else %}{% url 'jobs:parse_candidates' %}{% endif %}"
      hx-target="#parsing-result"
      hx-swap="innerHTML">
    {% csrf_token %}
    <div class="mb-3">
        <textarea name="text_content" class="form-control" rows="8">{{ full_text }}</textarea>
    </div>
    <div class="row align-items-end">
        <div class="col-md-6">
            <label for="model_provider" class="form-label"><strong>选择解析模型</strong></label>
            {% if not enabled_models %}
                <select name="model_provider" id="model_provider" class="form-select" disabled>
                    <option value="">请先在"API密钥管理"页面添加密钥</option>
                </select>
                <div class="alert alert-warning mt-2">
                    <i class="fas fa-exclamation-triangle"></i>
                    请先在"API密钥管理"页面添加相应的API密钥以启用AI模型。
                </div>
            {% else %}
                <select name="model_provider" id="model_provider" class="form-select enhanced-model-selector">
                    {% for key, model in enabled_models.items %}
                        <option value="{{ key }}" 
                                data-description="{{ model.description }}"
                                data-context="{{ model.features.context_length|default:'标准' }}"
                                data-scenario="{{ model.features.suitable_for|default:'通用场景' }}"
                                {% if key == 'qwen_plus' %}selected{% endif %}>
                            {{ model.name }}
                            {% if model.features.context_length %} ({{ model.features.context_length }}){% endif %}
                        </option>
                    {% endfor %}
                </select>
                
                <!-- 模型信息显示区域 -->
                <div id="model-info" class="mt-2 p-2 bg-light rounded" style="display: none;">
                    <div class="row">
                        <div class="col-md-12">
                            <small class="text-muted">
                                <strong>模型描述:</strong> <span id="model-description"></span>
                            </small>
                        </div>
                    </div>
                    <div class="row mt-1">
                        <div class="col-md-6">
                            <small class="text-muted">
                                <strong>上下文:</strong> <span id="model-context"></span>
                            </small>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">
                                <strong>适用场景:</strong> <span id="model-scenario"></span>
                            </small>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
        <div class="col-md-6 text-md-end mt-3 mt-md-0">
            <button type="submit" class="btn btn-success" {% if not enabled_models %}disabled{% endif %}>
                <span class="htmx-indicator spinner-border spinner-border-sm"></span>
                开始AI解析
            </button>
        </div>
    </div>
</form>

<!-- 解析结果显示区域 -->
<div id="parsing-result" class="mt-4">
    <!-- HTMX 解析结果将显示在这里 -->
</div>

<style>
.enhanced-model-selector {
    position: relative;
}

#model-info {
    border-left: 4px solid #007bff;
    transition: all 0.3s ease;
}

.model-feature-tag {
    background: #e3f2fd;
    color: #1976d2;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 0.7em;
    margin-right: 4px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modelSelect = document.getElementById('model_provider');
    const modelInfo = document.getElementById('model-info');
    const modelDescription = document.getElementById('model-description');
    const modelContext = document.getElementById('model-context');
    const modelScenario = document.getElementById('model-scenario');
    
    function updateModelInfo() {
        const selectedOption = modelSelect.options[modelSelect.selectedIndex];
        
        if (selectedOption && selectedOption.value) {
            const description = selectedOption.getAttribute('data-description') || '暂无描述';
            const context = selectedOption.getAttribute('data-context') || '标准';
            const scenario = selectedOption.getAttribute('data-scenario') || '通用场景';
            
            modelDescription.textContent = description;
            modelContext.textContent = context;
            modelScenario.textContent = scenario;
            
            modelInfo.style.display = 'block';
        } else {
            modelInfo.style.display = 'none';
        }
    }
    
    // 初始化显示
    if (modelSelect) {
        updateModelInfo();
        
        // 监听选择变化
        modelSelect.addEventListener('change', updateModelInfo);
    }
});
</script>