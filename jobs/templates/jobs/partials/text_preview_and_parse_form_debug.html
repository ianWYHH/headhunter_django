{% csrf_token %}
<div class="alert alert-info">
    <i class="bi bi-check-circle-fill"></i>
    è¯»å–æˆåŠŸï¼å…±è¯†åˆ«å‡º <strong>{{ total_items_to_parse }}</strong> æ¡å¾…è§£æå†…å®¹ã€‚
    {% if enabled_models %}
        è¯·æ£€æŸ¥ä¸‹æ–¹æ–‡æœ¬ï¼Œå¹¶é€‰æ‹©ä¸€ä¸ªAIæ¨¡å‹ã€‚
    {% else %}
        <span class="text-danger">ä½†æ‚¨å°šæœªé…ç½®ä»»ä½•å¯ç”¨çš„AIæ¨¡å‹ã€‚</span>
    {% endif %}
</div>

<!-- è°ƒè¯•ä¿¡æ¯ -->
<div class="alert alert-warning">
    <strong>è°ƒè¯•ä¿¡æ¯:</strong>
    <br>å¯ç”¨æ¨¡å‹æ•°é‡: {{ enabled_models|length }}
    <br>å½“å‰ç”¨æˆ·: {{ user.username }}
    <br>å†…å®¹ç±»å‹: {{ content_type }}
</div>

<form id="parse-text-form"
      hx-post="{% if content_type == 'job' %}{% url 'jobs:parse_jobs' %}{% else %}{% url 'jobs:parse_candidates' %}{% endif %}"
      hx-target="#parse-results-container"
      hx-swap="innerHTML"
      hx-indicator=".htmx-indicator">
    {% csrf_token %}
    <div class="mb-3">
        <textarea name="text_content" class="form-control" rows="8">{{ full_text }}</textarea>
    </div>
    <div class="row align-items-end">
        <div class="col-md-6">
            <label for="model_provider" class="form-label"><strong>é€‰æ‹©è§£ææ¨¡å‹</strong></label>
            {% if not enabled_models %}
                <select name="model_provider" id="model_provider" class="form-select" disabled>
                    <option value="">è¯·å…ˆåœ¨"APIå¯†é’¥ç®¡ç†"é¡µé¢æ·»åŠ å¯†é’¥</option>
                </select>
            {% else %}
                <select name="model_provider" id="model_provider" class="form-select" required>
                    {% for key, model in enabled_models.items %}
                        <option value="{{ key }}" 
                                data-description="{{ model.description|default:'æš‚æ— æè¿°' }}"
                                data-context="{{ model.features.context_length|default:'æ ‡å‡†' }}"
                                data-scenario="{{ model.features.suitable_for|default:'é€šç”¨åœºæ™¯' }}"
                                {% if key == 'qwen_plus' %}selected{% endif %}>
                            {{ model.name }}
                            {% if model.features.context_length %} ({{ model.features.context_length }}){% endif %}
                        </option>
                    {% endfor %}
                </select>
                
                <!-- æ¨¡å‹ä¿¡æ¯æ˜¾ç¤º -->
                <div id="model-info" class="mt-2 p-2 bg-light rounded" style="border-left: 4px solid #007bff;">
                    <div class="row">
                        <div class="col-md-12">
                            <small class="text-muted">
                                <strong>å½“å‰é€‰æ‹©:</strong> <span id="current-model">æ­£åœ¨åŠ è½½...</span>
                            </small>
                        </div>
                    </div>
                    <div class="row mt-1">
                        <div class="col-md-12">
                            <small class="text-muted">
                                <strong>æ¨¡å‹æè¿°:</strong> <span id="model-description">æš‚æ— æè¿°</span>
                            </small>
                        </div>
                    </div>
                    <div class="row mt-1">
                        <div class="col-md-6">
                            <small class="text-muted">
                                <strong>ä¸Šä¸‹æ–‡:</strong> <span id="model-context">æ ‡å‡†</span>
                            </small>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">
                                <strong>é€‚ç”¨åœºæ™¯:</strong> <span id="model-scenario">é€šç”¨åœºæ™¯</span>
                            </small>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
        <div class="col-md-6 text-md-end mt-3 mt-md-0">
            <button type="submit" class="btn btn-success" {% if not enabled_models %}disabled{% endif %}>
                <span class="htmx-indicator spinner-border spinner-border-sm me-2"></span>
                å¼€å§‹AIè§£æ
            </button>
        </div>
    </div>
</form>

<!-- AIè§£æç»“æœå®¹å™¨ -->
<div id="parse-results-container" class="mt-4">
    <!-- HTMXå°†åœ¨è¿™é‡ŒåŠ è½½è§£æç»“æœ -->
</div>

<!-- è°ƒè¯•ç»“æœå®¹å™¨ -->
<div id="debug-info" class="mt-3">
    <h5>è°ƒè¯•ä¿¡æ¯:</h5>
    <ul id="debug-list">
        <li>é¡µé¢å·²åŠ è½½</li>
    </ul>
</div>

<script>
// è°ƒè¯•è„šæœ¬
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ”§ è°ƒè¯•æ¨¡å¼æ¿€æ´»');
    
    const form = document.getElementById('parse-text-form');
    const debugList = document.getElementById('debug-list');
    const modelSelect = document.getElementById('model_provider');
    const currentModel = document.getElementById('current-model');
    
    function addDebugInfo(message) {
        const li = document.createElement('li');
        li.textContent = new Date().toLocaleTimeString() + ': ' + message;
        debugList.appendChild(li);
        console.log('ğŸ”§ ' + message);
    }
    
    if (form) {
        addDebugInfo('è¡¨å•å…ƒç´ æ‰¾åˆ°');
        
        // ç›‘å¬è¡¨å•æäº¤
        form.addEventListener('submit', function(e) {
            addDebugInfo('è¡¨å•æäº¤äº‹ä»¶è§¦å‘');
            console.log('è¡¨å•æ•°æ®:', new FormData(form));
        });
        
        // ç›‘å¬HTMXäº‹ä»¶
        form.addEventListener('htmx:beforeRequest', function(e) {
            addDebugInfo('HTMXè¯·æ±‚å¼€å§‹');
        });
        
        form.addEventListener('htmx:afterRequest', function(e) {
            addDebugInfo('HTMXè¯·æ±‚å®Œæˆï¼ŒçŠ¶æ€: ' + e.detail.xhr.status);
        });
        
        form.addEventListener('htmx:responseError', function(e) {
            addDebugInfo('HTMXå“åº”é”™è¯¯: ' + e.detail.xhr.status);
        });
        
    } else {
        addDebugInfo('âŒ è¡¨å•å…ƒç´ æœªæ‰¾åˆ°');
    }
    
    // ç›‘å¬æ¨¡å‹é€‰æ‹©å˜åŒ–
    if (modelSelect && currentModel) {
        const modelDescription = document.getElementById('model-description');
        const modelContext = document.getElementById('model-context');
        const modelScenario = document.getElementById('model-scenario');
        
        function updateModelInfo() {
            const selectedOption = modelSelect.options[modelSelect.selectedIndex];
            if (selectedOption && selectedOption.value) {
                // æ›´æ–°å½“å‰é€‰æ‹©
                currentModel.textContent = selectedOption.text;
                
                // æ›´æ–°è¯¦ç»†ä¿¡æ¯
                const description = selectedOption.getAttribute('data-description') || 'æš‚æ— æè¿°';
                const context = selectedOption.getAttribute('data-context') || 'æ ‡å‡†';
                const scenario = selectedOption.getAttribute('data-scenario') || 'é€šç”¨åœºæ™¯';
                
                if (modelDescription) modelDescription.textContent = description;
                if (modelContext) modelContext.textContent = context;
                if (modelScenario) modelScenario.textContent = scenario;
                
                addDebugInfo('æ¨¡å‹é€‰æ‹©å˜æ›´ä¸º: ' + selectedOption.value + ' (' + selectedOption.text + ')');
                addDebugInfo('æ¨¡å‹æè¿°: ' + description);
            }
        }
        
        updateModelInfo();
        modelSelect.addEventListener('change', updateModelInfo);
    }
    
    // æ£€æŸ¥HTMXæ˜¯å¦åŠ è½½
    if (typeof htmx !== 'undefined') {
        addDebugInfo('âœ… HTMXå·²åŠ è½½');
    } else {
        addDebugInfo('âŒ HTMXæœªåŠ è½½');
    }
});
</script>